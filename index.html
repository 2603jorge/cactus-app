<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgriCactus Sistema Maestro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --p: #1b5e20; --s: #f4f7f6; --danger: #c62828; --info: #0277bd; --accent: #ff9800; }
        body { font-family: sans-serif; background: var(--s); margin: 0; padding: 10px; padding-bottom: 80px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        label { display: block; font-weight: bold; font-size: 11px; color: #555; margin-top: 10px; }
        input, select { width: 100%; height: 50px; margin-top: 5px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; padding: 0 10px; box-sizing: border-box; }
        .nav-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn-nav { padding: 12px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; }
        .btn-config { background: #607d8b; }
        .btn-view { background: var(--info); }
        #status { text-align: center; font-weight: bold; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .btn-manual { background: var(--accent); color: white; border: none; border-radius: 8px; padding: 0 15px; font-weight: bold; }
        .btn-export { width: calc(100% - 20px); background: var(--p); color: white; padding: 20px; border: none; border-radius: 10px; font-weight: bold; position: fixed; bottom: 10px; left: 10px; }
    </style>
</head>
<body>

<div class="nav-buttons">
    <button class="btn-nav btn-config" onclick="document.getElementById('config').style.display='block'">‚öôÔ∏è CONFIG</button>
    <button class="btn-nav btn-view" onclick="abrirRegistros()">üìã VER (<span id="count">0</span>)</button>
</div>

<div id="config" class="modal">
    <h3>Configuraci√≥n</h3>
    <label>PEGAR MAPEO (ACTIVIDAD, EMPLEADO)</label>
    <textarea id="importPuestos" style="width:100%; height:100px; border: 1px solid #999;" placeholder="Ejemplo: 1000, 13534"></textarea>
    <button onclick="guardarMapeo()" style="width:100%; padding:15px; background:var(--p); color:white; margin-top:5px; border:none; border-radius:8px;">üíæ GUARDAR ASIGNACIONES</button>
    
    <hr style="margin:20px 0;">
    
    <label>CAT√ÅLOGOS (CUADROS O ACTIVIDADES GENERALES)</label>
    <textarea id="importInput" style="width:100%; height:100px; border: 1px solid #999;"></textarea>
    <button onclick="procesarCarga()" style="width:100%; padding:15px; background:black; color:white; margin-top:5px; border:none; border-radius:8px;">üì• CARGAR CAT√ÅLOGOS</button>
    
    <button onclick="document.getElementById('config').style.display='none'" style="width:100%; padding:15px; margin-top:30px; background:#ddd; border:none; border-radius:8px;">‚ùå CERRAR</button>
</div>

<div class="card">
    <label>SUPERVISOR</label>
    <input type="text" id="sup" oninput="localStorage.setItem('c_sup', this.value)">
    
    <label>CUADRO / LOTE</label>
    <input type="text" id="busC" placeholder="Buscar..." oninput="filtrar()">
    <select id="selC"></select>

    <label>ACTIVIDAD (Para personal sin puesto fijo)</label>
    <input type="text" id="busA" placeholder="Buscar..." oninput="filtrar()">
    <select id="selA"></select>
</div>

<div class="card">
    <div style="display:flex; gap:5px; margin-bottom:10px;">
        <input type="text" id="manualCode" placeholder="C√≥digo..." onkeypress="if(event.key==='Enter') registrarManual()">
        <button class="btn-manual" onclick="registrarManual()">A√ëADIR</button>
    </div>
    <div id="reader"></div>
    <div id="status">LISTO</div>
</div>

<button class="btn-export" onclick="exportar()">DESCARGAR REPORTE (CSV)</button>

<div id="modalRegs" class="modal">
    <div style="display:flex; justify-content:space-between;">
        <h3>Registros</h3>
        <button onclick="limpiarSoloRegistros()" style="color:red; border:none; background:none;">üóëÔ∏è Borrar Todo</button>
    </div>
    <div id="listaRegistros"></div>
    <button onclick="document.getElementById('modalRegs').style.display='none'" style="width:100%; padding:15px; margin-top:20px; background:#ddd; border:none; border-radius:8px;">‚ùå VOLVER</button>
</div>

<script>
let CUADROS = JSON.parse(localStorage.getItem('c_cuadros')) || [];
let ACTS = JSON.parse(localStorage.getItem('c_acts')) || [];
let MAPEO_PUESTOS = JSON.parse(localStorage.getItem('c_mapeo')) || {}; // { "13534": "1000" }
let REGS = JSON.parse(localStorage.getItem('c_regs')) || [];
let isScanning = true;

// PITIDOS
function beep(f, d, t) {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = t; o.frequency.value = f;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + d/1000);
    o.stop(ctx.currentTime + d/1000);
}

function filtrar() {
    const fC = document.getElementById('busC').value;
    const fA = document.getElementById('busA').value.toLowerCase();
    document.getElementById('selC').innerHTML = CUADROS.filter(c => c.id.includes(fC)).map(c => `<option value="${c.id}" data-v="${c.v}">${c.n}</option>`).join('');
    document.getElementById('selA').innerHTML = ACTS.filter(a => a.n.toLowerCase().includes(fA) || a.id.includes(fA)).map(a => `<option value="${a.id}">${a.n}</option>`).join('');
}

function procesarRegistro(codigo) {
    const cod = codigo.trim();
    const status = document.getElementById('status');
    const cSel = document.getElementById('selC');

    if(!cSel.value) { alert("Elige Cuadro"); return; }
    
    // VALIDACIONES: Duplicados y Longitud
    if(cod.length > 5) { beep(150, 600, 'square'); status.innerText = "‚ùå ERROR: +5 D√çGITOS"; status.style.background = "#ffcdd2"; return; }
    if(REGS.find(r => r.e === cod)) { beep(150, 600, 'square'); status.innerText = "‚ùå DUPLICADO: " + cod; status.style.background = "#ffcdd2"; return; }

    // ASIGNACI√ìN DE ACTIVIDAD (Mapeo autom√°tico)
    let actId;
    let esAuto = false;

    if (MAPEO_PUESTOS[cod]) {
        actId = MAPEO_PUESTOS[cod]; // Uso el c√≥digo de actividad del mapeo (ej: 1000)
        esAuto = true;
    } else {
        actId = document.getElementById('selA').value; // Uso el del selector manual
    }

    beep(880, 150, 'sine');
    
    const r = {
        id: Date.now(),
        f: new Date().toLocaleDateString('en-GB'),
        c: cSel.value, a: actId, e: cod,
        j: document.getElementById('selJ').value,
        s: document.getElementById('sup').value,
        v: cSel.selectedOptions[0]?.dataset.v || ""
    };

    REGS.push(r);
    localStorage.setItem('c_regs', JSON.stringify(REGS));
    document.getElementById('count').innerText = REGS.length;
    
    status.innerText = esAuto ? `‚≠ê AUTO: ${cod} ‚Üí Act ${actId}` : `‚úÖ OK: ${cod}`;
    status.style.background = esAuto ? "#c8e6c9" : "#e3f2fd";
}

function guardarMapeo() {
    const lines = document.getElementById('importPuestos').value.trim().split('\n');
    let nuevoMapeo = {};
    lines.forEach(l => {
        const p = l.split(',');
        if(p.length === 2) {
            const act = p[0].trim();
            const emp = p[1].trim();
            nuevoMapeo[emp] = act; // Guardamos { "13534": "1000" }
        }
    });
    MAPEO_PUESTOS = nuevoMapeo;
    localStorage.setItem('c_mapeo', JSON.stringify(MAPEO_PUESTOS));
    alert("Mapeo de empleados actualizado");
}

function procesarCarga() {
    const lines = document.getElementById('importInput').value.trim().split('\n');
    let nC = [], nA = [];
    lines.forEach(l => {
        const p = l.split(',');
        if(p.length === 3) nC.push({id: p[0].trim(), n: p[1].trim(), v: p[2].trim()});
        else if(p.length === 2) nA.push({id: p[0].trim(), n: p[1].trim()});
    });
    if(nC.length) { CUADROS = nC; localStorage.setItem('c_cuadros', JSON.stringify(CUADROS)); }
    if(nA.length) { ACTS = nA; localStorage.setItem('c_acts', JSON.stringify(ACTS)); }
    alert("Cat√°logos cargados");
    filtrar();
}

function registrarManual() {
    const i = document.getElementById('manualCode');
    if(i.value) { procesarRegistro(i.value); i.value = ""; i.focus(); }
}

function onScanSuccess(c) { if(!isScanning) return; isScanning = false; procesarRegistro(c); setTimeout(()=>isScanning=true, 2000); }

function abrirRegistros() {
    const container = document.getElementById('listaRegistros');
    container.innerHTML = REGS.length === 0 ? "Vacio" : "";
    REGS.slice().reverse().forEach(r => {
        const d = document.createElement('div');
        d.style.borderBottom = "1px solid #eee"; d.style.padding = "10px 0";
        d.innerHTML = `<b>${r.e}</b> ‚Üí Act: ${r.a}<br><small>${r.c}</small>`;
        container.appendChild(d);
    });
    document.getElementById('modalRegs').style.display = 'block';
}

function limpiarSoloRegistros() {
    if(confirm("¬øBorrar todo?")) { REGS = []; localStorage.setItem('c_regs', JSON.stringify(REGS)); location.reload(); }
}

function exportar() {
    let csv = "\ufeffFecha,Cuadro,Actividad,Empleado,Jornada,Supervisor,Variedad\n";
    REGS.forEach(r => { csv += `${r.f},${r.c},${r.a},"${r.e}",${r.j},"${r.s}","${r.v}"\n`; });
    const b = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(b);
    a.download = `Reporte.csv`;
    a.click();
}

window.onload = () => {
    document.getElementById('sup').value = localStorage.getItem('c_sup') || "";
    document.getElementById('count').innerText = REGS.length;
    filtrar();
    if(typeof Html5QrcodeScanner !== 'undefined') {
        new Html5QrcodeScanner("reader", { fps: 20, qrbox: 250 }).render(onScanSuccess);
    }
};
</script>
</body>
</html>
