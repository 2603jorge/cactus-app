<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgriCactus Sistema Maestro</title>
    <script src="https://unpkg.com/html5-qrcode" onerror="console.log('Modo manual: Sin internet para cargar c√°mara')"></script>
    <style>
        :root { --p: #1b5e20; --s: #f4f7f6; --danger: #c62828; --info: #0277bd; --accent: #ff9800; }
        body { font-family: sans-serif; background: var(--s); margin: 0; padding: 10px; padding-bottom: 80px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        label { display: block; font-weight: bold; font-size: 11px; color: #555; margin-top: 10px; }
        input, select { width: 100%; height: 50px; margin-top: 5px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; padding: 0 10px; box-sizing: border-box; }
        .nav-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .btn-nav { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }
        .btn-config { background: #607d8b; }
        .btn-view { background: var(--info); }
        .manual-entry { display: flex; gap: 5px; margin-bottom: 10px; }
        .manual-entry input { margin-top: 0; border: 2px solid var(--accent); }
        .btn-manual { background: var(--accent); color: white; border: none; border-radius: 8px; padding: 0 15px; font-weight: bold; cursor: pointer; }
        .btn-export { width: 100%; background: var(--p); color: white; padding: 20px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; position: fixed; bottom: 10px; left: 0; width: calc(100% - 20px); margin: 0 10px; z-index: 100; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; cursor: pointer; font-weight: bold; }
        #status { text-align: center; font-weight: bold; padding: 10px; color: var(--p); min-height: 20px; }
        .reg-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0; font-size: 13px; }
        .btn-del-mini { background: #ffcdd2; color: #c62828; border: none; padding: 5px 10px; border-radius: 4px; font-weight: bold; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .header-modal { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #offline-notice { background: #ffebee; color: #c62828; padding: 5px; font-size: 10px; text-align: center; border-radius: 5px; display: none; }
    </style>
</head>
<body>

<div id="offline-notice">‚ö†Ô∏è MODO OFFLINE: C√°mara desactivada, usa entrada manual.</div>

<div class="nav-buttons">
    <button class="btn-nav btn-config" onclick="document.getElementById('config').style.display='block'">‚öôÔ∏è CONFIG</button>
    <button class="btn-nav btn-view" onclick="abrirRegistros()">üìã VER (<span id="count">0</span>)</button>
</div>

<div id="config" class="modal">
    <h3>Configuraci√≥n</h3>
    <label>PEGAR DATOS (CSV: ID, NOMBRE, VARIEDAD)</label>
    <textarea id="importInput" style="width:100%; height:150px; border: 1px solid #999;"></textarea>
    <button onclick="procesarCarga()" style="width:100%; padding:15px; background:black; color:white; margin-top:10px; border:none; border-radius:8px;">üì• GUARDAR CAT√ÅLOGOS</button>
    <hr style="margin: 30px 0;">
    <button class="btn-danger" onclick="resetTotal()">‚ö†Ô∏è RESET COMPLETO</button>
    <button onclick="document.getElementById('config').style.display='none'" style="width:100%; padding:15px; margin-top:20px; background:#ddd; border:none; border-radius:8px;">‚ùå CERRAR</button>
</div>

<div id="modalRegs" class="modal">
    <div class="header-modal">
        <h3>Registros (<span id="totalRegsInfo">0</span>)</h3>
        <button class="btn-del-mini" style="padding: 10px;" onclick="limpiarSoloRegistros()">üóëÔ∏è BORRAR TODO</button>
    </div>
    <div id="listaRegistros"></div>
    <button onclick="document.getElementById('modalRegs').style.display='none'" style="width:100%; padding:15px; margin-top:20px; background:#ddd; border:none; border-radius:8px;">‚ùå VOLVER</button>
</div>

<div class="card">
    <label>SUPERVISOR</label>
    <input type="text" id="sup" placeholder="Nombre..." oninput="localStorage.setItem('c_sup', this.value)">
    
    <label>CUADRO / LOTE</label>
    <input type="text" id="busC" placeholder="Buscar cuadro..." oninput="filtrar()">
    <select id="selC"></select>

    <label>ACTIVIDAD</label>
    <input type="text" id="busA" placeholder="Buscar actividad..." oninput="filtrar()">
    <select id="selA"></select>

    <label>JORNADA</label>
    <select id="selJ">
        <option value="9">MATUTINA</option>
        <option value="11">VESPERTINA</option>
        <option value="16">1 TAREA</option>
        <option value="15">MATUTINA-VESPERTINA</option>
        <option value="20">CONTRATO</option>
        <option value="22">CUOTA TAXI</option>
    </select>
</div>

<div class="card">
    <label>ENTRADA MANUAL / LECTOR USB</label>
    <div class="manual-entry">
        <input type="text" id="manualCode" placeholder="C√≥digo..." onkeypress="if(event.key==='Enter') registrarManual()">
        <button class="btn-manual" onclick="registrarManual()">A√ëADIR</button>
    </div>
    <hr>
    <div id="reader"></div>
    <div id="status">SISTEMA LISTO</div>
</div>

<button class="btn-export" onclick="exportar()">DESCARGAR REPORTE (CSV)</button>

<script>
let CUADROS = JSON.parse(localStorage.getItem('c_cuadros')) || [];
let ACTS = JSON.parse(localStorage.getItem('c_acts')) || [];
let REGS = JSON.parse(localStorage.getItem('c_regs')) || [];
let isScanning = true;

// --- FUNCI√ìN PARA EL PITIDO ---
function beep(frecuencia = 440, duracion = 200, tipo = 'sine') {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.type = tipo;
    oscillator.frequency.setValueAtTime(frecuencia, audioCtx.currentTime);
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.start();
    gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duracion/1000);
    oscillator.stop(audioCtx.currentTime + duracion/1000);
}

window.onload = () => {
    document.getElementById('sup').value = localStorage.getItem('c_sup') || "";
    actualizarContador();
    filtrar();
    
    if (typeof Html5QrcodeScanner === 'undefined') {
        document.getElementById('offline-notice').style.display = 'block';
        document.getElementById('reader').innerHTML = "<p style='text-align:center; color:gray;'>C√°mara no disponible sin internet.<br>Usa el modo manual arriba.</p>";
    } else {
        const scanner = new Html5QrcodeScanner("reader", { fps: 20, qrbox: 250 });
        scanner.render(onScanSuccess);
    }
};

function actualizarContador() {
    const count = REGS.length;
    document.getElementById('count').innerText = count;
    document.getElementById('totalRegsInfo').innerText = count;
}

function filtrar() {
    const fC = document.getElementById('busC').value;
    const fA = document.getElementById('busA').value.toLowerCase();
    document.getElementById('selC').innerHTML = CUADROS.filter(c => c.id.includes(fC)).map(c => `<option value="${c.id}" data-v="${c.v}">${c.n}</option>`).join('');
    document.getElementById('selA').innerHTML = ACTS.filter(a => a.n.toLowerCase().includes(fA) || a.id.includes(fA)).map(a => `<option value="${a.id}">${a.n}</option>`).join('');
}

function procesarRegistro(codigo) {
    const cSel = document.getElementById('selC');
    const codLimpio = codigo.trim();

    // 1. VALIDACI√ìN: Seleccionar cuadro
    if(!cSel.value) return alert("Error: Selecciona un Cuadro primero.");

    // 2. VALIDACI√ìN: M√°s de 5 d√≠gitos
    if(codLimpio.length > 5) {
        beep(150, 500, 'square'); // Pitido de error (grave)
        document.getElementById('status').innerText = "‚ùå ERROR: M√ÅXIMO 5 D√çGITOS";
        document.getElementById('status').style.color = "red";
        return false;
    }

    // 3. VALIDACI√ìN: Duplicados
    const existe = REGS.find(r => r.e === codLimpio);
    if(existe) {
        beep(150, 500, 'square'); // Pitido de error
        document.getElementById('status').innerText = "‚ùå ERROR: YA ESCANEADO (" + codLimpio + ")";
        document.getElementById('status').style.color = "red";
        return false;
    }

    // Si pasa las validaciones...
    beep(880, 150, 'triangle'); // Pitido de √©xito (agudo)

    const r = { 
        id: Date.now(),
        f: new Date().toLocaleDateString('en-GB'), 
        c: cSel.value, 
        a: document.getElementById('selA').value, 
        e: codLimpio, 
        j: document.getElementById('selJ').value, 
        s: document.getElementById('sup').value, 
        v: cSel.selectedOptions[0]?.dataset.v || ""
    };

    REGS.push(r);
    localStorage.setItem('c_regs', JSON.stringify(REGS));
    actualizarContador();
    document.getElementById('status').innerText = "‚úÖ OK: " + codLimpio;
    document.getElementById('status').style.color = "blue";
    return true;
}

function registrarManual() {
    const input = document.getElementById('manualCode');
    if(input.value.trim() !== "") {
        if(procesarRegistro(input.value)) {
            input.value = "";
            input.focus();
        }
    }
}

function onScanSuccess(codigo) {
    if(!isScanning) return;
    
    isScanning = false; // Bloqueo temporal para evitar m√∫ltiples lecturas
    procesarRegistro(codigo);
    
    setTimeout(() => { isScanning = true; }, 2000); // Espera 2 segundos para el siguiente escaneo
}

// ... Resto de funciones (abrirRegistros, borrarRegistro, etc.) se mantienen igual ...
function abrirRegistros() {
    const container = document.getElementById('listaRegistros');
    container.innerHTML = REGS.length === 0 ? "<p>Vac√≠o</p>" : "";
    REGS.slice(-100).reverse().forEach(r => {
        const div = document.createElement('div');
        div.className = 'reg-item';
        div.innerHTML = `<div><b>${r.e}</b><br><small>${r.c} | ${r.a}</small></div>
            <button class="btn-del-mini" onclick="borrarRegistro(${r.id})">X</button>`;
        container.appendChild(div);
    });
    document.getElementById('modalRegs').style.display = 'block';
}

function borrarRegistro(id) {
    REGS = REGS.filter(r => r.id !== id);
    localStorage.setItem('c_regs', JSON.stringify(REGS));
    actualizarContador();
    abrirRegistros();
}

function limpiarSoloRegistros() {
    if (confirm("¬øBorrar todos los registros?")) {
        REGS = [];
        localStorage.setItem('c_regs', JSON.stringify(REGS));
        actualizarContador();
        document.getElementById('modalRegs').style.display = 'none';
    }
}

function procesarCarga() {
    const raw = document.getElementById('importInput').value.trim().split('\n');
    raw.forEach(linea => {
        const p = linea.split(',');
        if(p.length === 3) CUADROS.push({id: p[0].trim(), n: p[1].trim(), v: p[2].trim()});
        else if(p.length === 2) ACTS.push({id: p[0].trim(), n: p[1].trim()});
    });
    localStorage.setItem('c_cuadros', JSON.stringify(CUADROS));
    localStorage.setItem('c_acts', JSON.stringify(ACTS));
    alert("Cat√°logos guardados");
    document.getElementById('config').style.display='none';
    filtrar();
}

function exportar() {
    let csv = "\ufeffFecha,Cuadro,Actividad,CodigoEmpleado,Jornada,Supervisor,Variedad\n";
    REGS.forEach(r => { csv += `${r.f},${r.c},${r.a},"${r.e}",${r.j},"${r.s}","${r.v}"\n`; });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Reporte_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
}

function resetTotal() {
    if(confirm("¬øRESET TOTAL?")) { localStorage.clear(); location.reload(); }
}
</script>
</body>
</html>

