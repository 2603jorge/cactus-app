<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgriCactus Sistema Maestro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --p: #1b5e20; --s: #f4f7f6; --danger: #c62828; }
        body { font-family: sans-serif; background: var(--s); margin: 0; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
        label { display: block; font-weight: bold; font-size: 11px; color: #555; margin-top: 10px; }
        input, select { width: 100%; height: 50px; margin-top: 5px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; padding: 0 10px; box-sizing: border-box; }
        .btn-config { background: #607d8b; padding: 10px; font-size: 10px; color: white; border: none; border-radius: 5px; width: 100%; margin-bottom: 10px; }
        .btn-export { width: 100%; background: var(--p); color: white; padding: 20px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 10px; border-radius: 5px; width: 100%; margin-top: 20px; font-weight: bold; cursor: pointer; }
        #status { text-align: center; font-weight: bold; padding: 10px; color: var(--p); }
        .import-msg { font-size: 10px; color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

<button class="btn-config" onclick="document.getElementById('config').style.display='block'">‚öôÔ∏è CONFIGURACI√ìN / CARGAR DATOS</button>

<div id="config" class="card" style="display:none; position:fixed; top:10px; left:10px; right:10px; bottom:10px; z-index:2000; border:2px solid #333; overflow-y: auto;">
    <h3>Panel de Control</h3>
    <div class="import-msg">Pega aqu√≠ los bloques de texto (Cuadros o Actividades):</div>
    <textarea id="importInput" style="width:100%; height:150px; border: 1px solid #999;"></textarea>
    
    <button onclick="procesarCarga()" style="width:100%; padding:15px; background:black; color:white; margin-top:10px; cursor:pointer;">üì• GUARDAR BLOQUE</button>
    
    <hr style="margin: 20px 0;">
    
    <p style="color: var(--danger); font-size: 12px; font-weight: bold;">ZONA DE PELIGRO:</p>
    <button class="btn-danger" onclick="resetTotal()">‚ö†Ô∏è RESET TOTAL (BORRAR TODO)</button>
    
    <button onclick="document.getElementById('config').style.display='none'" style="width:100%; padding:15px; margin-top:15px; background:#ddd; border:none; border-radius:5px; cursor:pointer;">‚ùå CERRAR PANEL</button>
</div>

<div class="card">
    <label>SUPERVISOR</label>
    <input type="text" id="sup" placeholder="Nombre o N√≥mina..." oninput="localStorage.setItem('c_sup', this.value)">
    
    <label>BUSCAR CUADRO</label>
    <input type="text" id="busC" placeholder="Ej: 529" oninput="filtrar()">
    <select id="selC"></select>

    <label>BUSCAR ACTIVIDAD</label>
    <input type="text" id="busA" placeholder="Ej: Poda" oninput="filtrar()">
    <select id="selA"></select>

    <label>JORNADA</label>
    <select id="selJ">
        <option value="9">MATUTINA</option><option value="11">VESPERTINA</option><option value="16">1 TAREA</option>
    </select>
</div>

<div class="card">
    <div id="reader"></div>
    <div id="status">ESC√ÅNER LISTO</div>
</div>

<button class="btn-export" onclick="exportar()">DESCARGAR REPORTE CSV</button>

<script>
let CUADROS = JSON.parse(localStorage.getItem('c_cuadros')) || [];
let ACTS = JSON.parse(localStorage.getItem('c_acts')) || [];
let REGS = JSON.parse(localStorage.getItem('c_regs')) || [];

window.onload = () => {
    document.getElementById('sup').value = localStorage.getItem('c_sup') || "";
    filtrar();
};

function resetTotal() {
    if(confirm("¬øEST√ÅS SEGURO? Se borrar√°n todos los cuadros, las actividades y los registros del d√≠a. Esta acci√≥n no se puede deshacer.")) {
        localStorage.clear();
        CUADROS = []; ACTS = []; REGS = [];
        alert("Sistema Limpio. Debes cargar los datos nuevamente.");
        location.reload();
    }
}

function procesarCarga() {
    const raw = document.getElementById('importInput').value.trim().split('\n');
    let cCount = 0; let aCount = 0;
    
    raw.forEach(linea => {
        const p = linea.split(',');
        if(p.length === 3) {
            CUADROS.push({id: p[0].trim(), n: p[1].trim(), v: p[2].trim()});
            cCount++;
        } else if(p.length === 2) {
            ACTS.push({id: p[0].trim(), n: p[1].trim()});
            aCount++;
        }
    });
    
    localStorage.setItem('c_cuadros', JSON.stringify(CUADROS));
    localStorage.setItem('c_acts', JSON.stringify(ACTS));
    alert(`Carga exitosa:\n${cCount} Cuadros a√±adidos\n${aCount} Actividades a√±adidas`);
    document.getElementById('importInput').value = "";
    filtrar();
}

function filtrar() {
    const fC = document.getElementById('busC').value;
    const fA = document.getElementById('busA').value.toLowerCase();
    document.getElementById('selC').innerHTML = CUADROS.filter(c => c.id.includes(fC)).map(c => `<option value="${c.id}" data-v="${c.v}">${c.n}</option>`).join('');
    document.getElementById('selA').innerHTML = ACTS.filter(a => a.n.toLowerCase().includes(fA) || a.id.includes(fA)).map(a => `<option value="${a.id}">${a.n}</option>`).join('');
}

function onScanSuccess(codigo) {
    const cSel = document.getElementById('selC');
    if(!cSel.value) return alert("Selecciona Cuadro primero");
    const r = { f: new Date().toLocaleDateString('en-GB'), c: cSel.value, a: document.getElementById('selA').value, e: codigo, j: document.getElementById('selJ').value, s: document.getElementById('sup').value, v: cSel.selectedOptions[0].dataset.v };
    REGS.push(r);
    localStorage.setItem('c_regs', JSON.stringify(REGS));
    document.getElementById('status').innerText = "REGISTRADO: " + codigo;
    const audio = new Audio('https://www.soundjay.com/buttons/beep-07a.mp3');
    audio.play().catch(() => {});
}

function exportar() {
    let csv = "date,cuadroId,actividadId,Columna1,jornadaId,encargadold,variedadId\n";
    REGS.forEach(r => csv += `${r.f},${r.c},${r.a},${r.e},${r.j},${r.s},${r.v}\n`);
    const blob = new Blob([csv], { type: 'text/csv' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Reporte_AgriCactus.csv";
    link.click();
}

const scanner = new Html5QrcodeScanner("reader", { fps: 15, qrbox: 250 });
scanner.render(onScanSuccess);
</script>
</body>
</html>